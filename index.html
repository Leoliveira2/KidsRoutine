<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Heróis da Rotina</title>
  <meta name="theme-color" content="#667eea" />
  <meta name="description" content="Heróis da Rotina - app infantil gamificado" />
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --primary:#4f46e5;
      --primary-2:#667eea;
      --warn:#f59e0b;
      --ok:#10b981;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,'Segoe UI',Roboto,Arial; background:linear-gradient(135deg,#eef2ff 0%,#ede9fe 100%);
      color:var(--text);
    }
    .app{
      display:grid; grid-template-columns: minmax(300px,720px) 1fr; gap:24px; min-height:100vh;
      max-width:1200px; margin:0 auto; padding:24px;
    }
    .left{padding-right:8px}
    .right{background:linear-gradient(135deg,#7c3aed 0%, #6366f1 100%); border-radius:24px; box-shadow:var(--shadow)}
    .top-nav{
      display:flex; align-items:center; gap:12px; margin-bottom:16px;
    }
    .nav-btn{border:0; background:#fff; box-shadow:var(--shadow); width:44px;height:44px;border-radius:12px;cursor:pointer;font-size:20px}
    .nav-btn.active{outline:3px solid rgba(79,70,229,.25)}
    .app-title{font-weight:800; font-size:1.25rem}
    .section-title{font-weight:800; font-size:1.15rem; margin:16px 8px}
    .missions-list{display:flex; flex-direction:column; gap:12px}
    .mission-card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:16px; display:flex; justify-content:space-between; align-items:center;
    }
    .mission-info{max-width:70%}
    .mission-title{font-weight:800; font-size:1rem}
    .mission-desc{color:var(--muted); margin-top:4px; font-size:.9rem}
    .actions-row{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--primary); color:#fff}
    .btn-secondary{background:var(--warn); color:#fff}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#fff;
      box-shadow:var(--shadow); font-weight:700}
    .status-row{display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:12px 8px}
    .bar{height:10px;background:#e5e7eb;border-radius:999px; overflow:hidden}
    .bar > span{display:block;height:100%; background:linear-gradient(90deg,#22d3ee,#10b981)}
    #toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#111827;color:#fff;padding:12px 16px;border-radius:12px;display:none;z-index:9999
    }
    @media (prefers-reduced-motion: reduce){ *{animation:none !important; transition:none !important;} }
    @media (max-width: 980px){ .app{grid-template-columns:1fr} .right{min-height:220px} }
  </style>
</head>
<body>
  <div class="app">
    <div class="left">
      <div class="top-nav">
        <button id="btn-main" class="nav-btn active" title="Página Principal">🏠</button>
        <h1 class="app-title">Heróis da Rotina — Versão Completa</h1>
        <button id="btn-family" class="nav-btn" title="Modo Família">👨‍👩‍👧‍👦</button>
      </div>

      <!-- Status -->
      <div class="status-row">
        <span class="pill">⚡ Energia: <strong id="energia-val">0</strong></span>
        <span class="pill">🧼 Higiene: <strong id="higiene-val">0</strong></span>
        <span class="pill">😊 Felicidade: <strong id="felicidade-val">0</strong></span>
        <span class="pill">⭐ Pontos: <strong id="pontos-val">0</strong></span>
      </div>

      <!-- Barras -->
      <div style="padding:0 8px">
        <div class="bar"><span id="energia-bar" style="width:60%"></span></div>
        <div class="bar" style="margin-top:6px"><span id="higiene-bar" style="width:60%"></span></div>
        <div class="bar" style="margin-top:6px"><span id="felicidade-bar" style="width:60%"></span></div>
      </div>

      <!-- Missões padrão (4) -->
      <h2 class="section-title">🎯 Missões do Dia</h2>
      <div id="standard-missions" class="missions-list"></div>

      <!-- Atividades adicionais (do JSON) -->
      <section class="app-section active" id="extra-activities-section" aria-label="Atividades Adicionais">
        <h2 class="section-title">🧭 Atividades Adicionais</h2>
        <div id="extra-activities-list" class="missions-list"></div>
      </section>

      <!-- Conquistas (placeholder simples) -->
      <h2 class="section-title">🏆 Conquistas</h2>
      <div id="achievements" class="missions-list"></div>
    </div>

    <div class="right" aria-label="Painel Visual / Avatar" id="avatar" role="img"></div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    // =============================
    // Estado & Persistência
    // =============================
    const elements = {
      energiaVal: document.getElementById('energia-val'),
      higieneVal: document.getElementById('higiene-val'),
      felicidadeVal: document.getElementById('felicidade-val'),
      pontosVal: document.getElementById('pontos-val'),
      energiaBar: document.getElementById('energia-bar'),
      higieneBar: document.getElementById('higiene-bar'),
      felicidadeBar: document.getElementById('felicidade-bar'),
      stdList: document.getElementById('standard-missions'),
      extList: document.getElementById('extra-activities-list'),
      achievements: document.getElementById('achievements')
    };

    function showToast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(()=> el.style.display='none', 2600);
    }

    const PADRAO = [
      { id:'STD01', nome:'Fortaleza da Alvorada', desc:'Recarregue o Cristal da Força', bot1:'Refeição Completa', bot2:'Lanche Rápido', pontos:20, effects:{energia:+10, felicidade:+5} },
      { id:'STD02', nome:'Escudo de Menta', desc:'Derrote o Bafodonte', bot1:'Escovação Completa', bot2:'Pular Missão', pontos:15, effects:{higiene:+15, felicidade:+5} },
      { id:'STD03', nome:'Cascata Purificante', desc:'Ative a Barreira Protetora', bot1:'Banho Completo', bot2:'Banho Rápido', pontos:20, effects:{higiene:+20, felicidade:+5} },
      { id:'STD04', nome:'Fonte dos Sonhos', desc:'Recarregue todos os Cristais', bot1:'Dormir na Hora', bot2:'Dormir Tarde', pontos:25, effects:{energia:+25, felicidade:+10} }
    ];
    const PADRAO_NOMES = new Set(PADRAO.map(x=>x.nome));

    const gameState = {
      energia: 80, higiene: 70, felicidade: 65,
      pontosTotal: 25, missoesConcluidas: 2,
      conquistas: [], lastDayISO: null
    };

    function saveProgress(){
      try{ localStorage.setItem('heroesRoutineProgress', JSON.stringify(gameState)); }
      catch(e){ console.warn('Falha ao salvar:', e); }
    }
    function loadProgress(){
      try{
        const raw = localStorage.getItem('heroesRoutineProgress');
        if (raw){
          const st = JSON.parse(raw); Object.assign(gameState, st||{});
        }
      }catch(e){ console.warn('Falha ao carregar:', e); }
    }
    loadProgress();

    function clamp(v){ return Math.max(0, Math.min(100, v)); }
    function updateStatusBars(){
      elements.energiaVal.textContent = clamp(gameState.energia);
      elements.higieneVal.textContent = clamp(gameState.higiene);
      elements.felicidadeVal.textContent = clamp(gameState.felicidade);
      elements.pontosVal.textContent = gameState.pontosTotal||0;

      elements.energiaBar.style.width = clamp(gameState.energia) + '%';
      elements.higieneBar.style.width = clamp(gameState.higiene) + '%';
      elements.felicidadeBar.style.width = clamp(gameState.felicidade) + '%';
    }
    updateStatusBars();

    // =============================
    // Render: Missões padrão
    // =============================
    function renderStandard(){
      const root = elements.stdList; root.innerHTML='';
      PADRAO.forEach(m=>{
        const card = document.createElement('div');
        card.className = 'mission-card';
        card.innerHTML = `
          <div class="mission-info">
            <div class="mission-title">${m.nome}</div>
            <div class="mission-desc">${m.desc}</div>
          </div>
          <div class="actions-row">
            <button class="btn btn-primary" data-a="ok">${m.bot1}</button>
            <button class="btn btn-secondary" data-a="skip">${m.bot2}</button>
          </div>`;
        card.querySelector('[data-a="ok"]').addEventListener('click', ()=>{
          gameState.pontosTotal = (gameState.pontosTotal||0) + m.pontos;
          if (m.effects){
            gameState.energia = clamp((gameState.energia||0) + (m.effects.energia||0));
            gameState.higiene = clamp((gameState.higiene||0) + (m.effects.higiene||0));
            gameState.felicidade = clamp((gameState.felicidade||0) + (m.effects.felicidade||0));
          }
          gameState.missoesConcluidas = (gameState.missoesConcluidas||0) + 1;
          updateStatusBars(); saveProgress();
          showToast(`✅ ${m.nome} concluída! +${m.pontos} pontos`);
          card.style.opacity=.5; card.style.pointerEvents='none';
        });
        card.querySelector('[data-a="skip"]').addEventListener('click', ()=>{
          showToast(`⏭️ ${m.nome} pulada`);
          card.style.opacity=.6;
        });
        root.appendChild(card);
      });
    }
    renderStandard();

    // =============================
    // Render: Atividades adicionais (JSON)
    // =============================
    window.atividades = window.atividades || []; // fonte dinâmica após JSON

    function normalizarAtividade(a){
      return {
        id: a.id || ('AUX_'+Math.random().toString(36).slice(2)),
        nome: a.nome || '',
        categoria: a.categoria || 'Geral',
        criterios: Array.isArray(a.criterios) ? a.criterios : [],
        recompensaPontos: Number.isFinite(a.recompensaPontos) ? a.recompensaPontos : 10,
        duracaoMin: Number.isFinite(a.duracaoMin) ? a.duracaoMin : 5,
        horarioSugerido: a.horarioSugerido || '',
        badgeAoCompletar: a.badgeAoCompletar || null
      };
    }

    function criarCardExtra(a){
      const wrap = document.createElement('div');
      wrap.className = 'mission-card extra-card';
      wrap.innerHTML = `
        <div class="mission-info">
          <div class="mission-title">${a.nome}</div>
          <div class="mission-desc">
            ${a.categoria} • ${a.duracaoMin} min ${a.horarioSugerido ? '• '+a.horarioSugerido : ''}
            ${a.criterios.length ? '<br><small>Critérios: '+a.criterios.join(', ')+'</small>' : ''}
          </div>
        </div>
        <div class="actions-row">
          <button class="btn btn-primary" data-action="concluir">Concluir (+${a.recompensaPontos})</button>
          <button class="btn btn-secondary" data-action="pular">Pular</button>
        </div>
      `;
      wrap.querySelector('[data-action="concluir"]').addEventListener('click', ()=>{
        gameState.pontosTotal = (gameState.pontosTotal||0) + a.recompensaPontos;
        gameState.missoesConcluidas = (gameState.missoesConcluidas||0) + 1;
        updateStatusBars(); saveProgress();
        showToast(`✅ ${a.nome} concluída! +${a.recompensaPontos} pontos`);
        wrap.style.opacity=.5; wrap.style.pointerEvents='none';
      });
      wrap.querySelector('[data-action="pular"]').addEventListener('click', ()=>{
        showToast(`⏭️ ${a.nome} pulada`);
        wrap.style.opacity=.6;
      });
      return wrap;
    }

    function renderExtraActivities(){
      const listEl = elements.extList; if (!listEl) return;
      let base = Array.isArray(window.atividades) ? window.atividades : (Array.isArray(window.externalActivities)? window.externalActivities : []);
      const items = base.map(normalizarAtividade).filter(x=>x.nome && !PADRAO_NOMES.has(x.nome));
      listEl.innerHTML='';
      if (!items.length){
        listEl.innerHTML = '<div class="mission-card extra-card"><div class="mission-info"><div class="mission-title">Sem atividades adicionais</div><div class="mission-desc">Atualize o <code>activities.json</code>.</div></div></div>';
        return;
      }
      items.forEach(a=> listEl.appendChild(criarCardExtra(a)));
    }

    window.renderizarAtividades = function(){ renderExtraActivities(); }; // compat
    window.addEventListener('external-activities-loaded', renderExtraActivities);
    window.addEventListener('activities-merged', renderExtraActivities);
    window.addEventListener('activities-overwritten', renderExtraActivities);

    // =============================
    // Loader OVERWRITE do activities.json
    // =============================
    (function(){
      async function overwriteActivities(){
        try{
          const resp = await fetch('activities.json', { cache: 'no-store' });
          if(!resp.ok) throw new Error('HTTP '+resp.status);
          const novas = await resp.json();
          if (!Array.isArray(novas) || !novas.length){
            console.warn('[Overwrite] activities.json vazio ou inválido'); return;
          }
          // sobrescreve totalmente a fonte dinâmica
          window.atividades = novas.slice();
          // migra storage de forma suave
          try{
            const KEY='heroesRoutineProgress';
            const raw=localStorage.getItem(KEY);
            const st= raw? JSON.parse(raw):{};
            st.atividades = window.atividades;
            localStorage.setItem(KEY, JSON.stringify(st));
          }catch(e){ console.warn('[Overwrite] migração storage:', e); }

          // re-render
          renderExtraActivities();
          window.dispatchEvent(new CustomEvent('activities-overwritten',{detail:{total:window.atividades.length}}));
          console.log('[Overwrite] Atividades sobrescritas. Total:', window.atividades.length);
        }catch(e){
          console.warn('[Overwrite] Erro ao sobrescrever atividades:', e);
        }
      }
      if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', overwriteActivities);
      else overwriteActivities();
    })();

    console.log('🌟 Heróis da Rotina - Versão Completa carregado com sucesso!');
    console.log('Estado inicial:', JSON.parse(JSON.stringify(gameState)));
  </script>
</body>
</html>
